# Competing Consumers Pattern

This document describes the Competing Consumers Pattern example from the guide [Cloud Design Patterns](http://aka.ms/Cloud-Design-Patterns)

##	 System Requirements

* Microsoft .NET Core 3.1
* Microsoft Visual Studio 2019 Enterprise, or Professional
* Windows Azure SDK for .NET version 2.9
* Azure Subscription is required for the infrastructure deployment

## Before you start

Ensure that you have installed all of the software prerequisites.
 
The example demonstrates operational aspects of applications running in Windows Azure. Therefore, you will need to use the diagnostics tools in order to understand how the code sample works.

 
## About the Example
 
This example contains three components: the Sender Web Job is responsible for sending messages to a Service Bus queue, and the Receiver Web Job retrieves messages from the queue and processes them. The Competing Receiver Web Job competes with the receiver Web Job and also retrieves messages from the queue and processes them.

## Deploying the ARM template

The provided ARM template is used to deploy the required resources:
	
	1 - The Azure App Service Plan configured by the App Service
	2 - The Azure App Service that will host the Web Jobs
	3 - The Azure Service Bus Queue to which the messages will be sent.

#### Deployment instructions


#### Run these commands by using the Azure CLI from your computer. You need to run az login to log in to Azure. Make sure that you have a subscription associated with your Azure Account If the CLI can open your default browser, it will do so and load an Azure sign-in page. Otherwise, open a browser page at https://aka.ms/devicelogin and enter the authorization code displayed in your terminal.
<br><br>
1 - Log in to Azure.
<br><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;az login
<br><br>
2 - Deploy the ARM template provided by the sample, you will need to have a resource group already created.
<br><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;az deployment group create --resource-group [your resource-group-name] --template-file .\deploymentTemplate\CompetingConsumers.json
<br><br>
3 - Once the deployment has successfully completed go to the Azure Portal, you will see three new resources created under the resource group.

## Configuring the service bus on the Solution

* On the Azure Portal, go to your resource group
* Open the Service Bus resource named "sbcompetingconsumers"
* On the "settings" menu, click on "Shared Access Policies"
* Select the policy named "RootManageSharedAccessKey"
* Copy the primary connection string to the clipboard
* Go to your solution and replace the "ServiceBusConnectionString" place holder value in every app.config in all the projects

## Creating the Web Jobs

You can publish the Web Jobs by using Visual Studio 2019, follow these instructions for every project in the solution:
 
* Start Visual Studio using an account that has Administrator privileges ("Run as Administrator").
* Right click on the Console App project
* Select "publish"
* Click on "publish" button
* On the Publish dialog, select "Azure, Publish your application to the Microsoft clud"
* Click "Next"
* On the next Dialog, Select "Azure WebJobs" 
* Click "Next"
* On the next dialog, select your subscription on the subscription's drop down list
* Select "Resource Group" on the View's drop down list
* On the list below, Click on the App Service you want the Web Job deployed in, you can use the Search box to locate it faster
* Click on "Finish"
* Once you have created the publish profile click on "Publish" Button

## Runing the example

* On the Azure Portal, go to your resource group and find the deployed App Service named "CompetingConsumers".
* On the "Settings" menu, click on "WebJobs"
* If you created the Web Jobs successfully by following the previous steps, there will be three Web Jobs on the list (Sender, Receiver and CompetingReceiver), all of type "Triggered" and status "Ready"
* You can run every Web Job by using the command toolbar

## Monitoring the example

Once all the Web Jobs are running, the sender job will be sending messages to the deployed service bus every ten seconds. And both receivers will be concurrently consuming and processing the messages received on the same messaging channel:

* On the Azure Portal, go to your resource group and find the deployed App Service named "CompetingConsumers".
* On the "Settings" menu, click on "WebJobs"
* On the Web Jobs list's upper toolbar click on "Logs", the navigation will show the "Microsoft Azure WebJobs" page
* Click on the "WebJobs" link
* A WebJobs list page will show up, you can click on a WebJob link to see the activity log

### Examples of log entries generated by the Sender WebJob

[06/23/2020 02:09:42 > 360773: INFO] Web Job started sending messages in a loop.<br>
[06/23/2020 02:09:42 > 360773: INFO] Sending message: Message 1232<br>
[06/23/2020 02:19:42 > 360773: INFO] Message successfully sent.

### Examples of log entries generated by the Receiver WebJobs

* Receiver:

[06/23/2020 02:29:23 > 360773: INFO] Received message: SequenceNumber:1232 Body:Message 1232<br>
[06/23/2020 02:30:12 > 360773: INFO] Received message: SequenceNumber:1234 Body:Message 1234

* Competing receiver:

[06/23/2020 02:29:23 > 360773: INFO] Received message: SequenceNumber:1233 Body:Message 1233